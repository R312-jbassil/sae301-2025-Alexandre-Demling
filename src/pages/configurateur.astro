---
import BaseLayout from "../layouts/BaseLayout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";

export const prerender = false;

const MATS = [
  { label: "Acétate", sub: "Léger et confortable" },
  { label: "Métal", sub: "Élégant et durable" },
  { label: "Bois", sub: "Naturel et unique" },
];

const MONTURE_COLORS = [
  { name: "Noir", value: "#111827" },
  { name: "Écaille", value: "#8b5a2b" },
  { name: "Gris", value: "#6b7280" },
];

const BRANCHES_COLORS = [
  { name: "Noir", value: "#111827" },
  { name: "Écaille", value: "#8b5a2b" },
  { name: "Gris", value: "#d1d5db" },
];
---
<!doctype html>
<html lang="fr" data-theme="tavue">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TaVue — Configurateur</title>
  </head>
  <body class="min-h-screen bg-base-200 text-base-content">
    <Header active="configurateur" />

    <main class="max-w-7xl mx-auto px-6 py-10">
      <!-- Titre -->
      <section class="text-center max-w-3xl mx-auto mb-10">
        <p class="uppercase tracking-widest text-xs opacity-60">Configurateur</p>
        <h1 class="text-4xl md:text-5xl font-extrabold mt-2">Créez vos lunettes sur mesure</h1>
        <p class="opacity-70 mt-3">Personnalisez chaque détail de vos lunettes. Fabrication française, qualité artisanale.</p>
      </section>

      <div class="flex justify-end mb-4">
        <a href="/configurateur/ia" class="btn btn-neutral">Créer avec l’IA</a>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        <!-- Aperçu -->
        <div class="lg:col-span-5">
          <div class="card bg-base-100 shadow-sm">
            <div class="card-body">
              <div class="rounded-2xl bg-base-200 flex items-center justify-center p-6 min-h-[320px]">
                <!-- SVG -->
                <svg id="lunettes-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 595.28 841.89" class="w-full max-w-[440px] h-auto">
                  <defs>
                    <style>
                      .cls-1{fill:#706f6f;mix-blend-mode:multiply;}
                      .cls-2{isolation:isolate;}
                      .cls-3,.cls-4{fill:#ffffff;}
                      .cls-4{stroke:#1d1d1b;stroke-miterlimit:10;stroke-width:.5px;}
                      .cls-5{fill:none;opacity:.75;}
                      /* Couleurs pilotées par variables */
                      #monture .cls-4{ fill: var(--monture-color, #111827); }
                      #branches .cls-4{ fill: var(--branches-color, #8b5a2b); }
                    </style>
                  </defs>
                  <g class="cls-2">
                    <g id="branches">
                      <path class="cls-4" d="M108.83,155.14s49.35-5.57,54.93-8.76,11.14-7.96,19.5-9.55,64.48-11.14,64.48-11.14c0,0,7.16-1.99,17.51,5.57s33.04,31.84,39.4,31.05c6.37-.8,9.55-9.55,7.56-13.53s-40.67-32.75-47.36-34.63c-9.53-2.68-21.89-2.39-37.02,0-15.12,2.39-116.22,23.34-116.22,23.34,0,0-13.13,6.12-2.79,17.66Z"/>
                      <path class="cls-1" d="M308.24,150.76s-.31,6.15-3.98,5.57c-4.97-.78-35.82-33.83-46.17-32.24,0,0,8.53,2.71,18.46,11.64,6.51,5.86,34.42,37.85,31.69,15.03Z"/>
                      <path class="cls-4" d="M374.79,179.65l90.54-29.78s22.13-5.63,25.35-4.02,17.71,30.58,17.71,33.8-2.42,14.01-5.63,14.89c-2.33.64-5.33.11-6.84-4.21-1.41-4.02-6.84-31.73-12.47-31.47s-50.7,15.95-50.7,15.95c0,0-13.28,6.44-18.91,11.27s-32.19,11.27-32.19,11.27c0,0-9.66-7.65-6.84-17.71Z"/>
                      <path class="cls-1" d="M381.34,180.1s102.27-35.19,107.85-31.99c0,0-18.2,2.49-41.76,11.88s-66.09,22.03-66.09,22.03v-1.92Z"/>
                      <path class="cls-1" d="M485.36,158.06s3.26,0,4.98,3.45,9.77,24.71,9.77,24.71c0,0,.77,4.98,5.17-2.68,0,0-3.07,9.56-5.36,6.79s-9.77-26.33-9.77-26.33c0,0-2.87-6.74-4.79-5.94Z"/>
                    </g>
                    <g id="monture">
                      <path class="cls-4" d="M385.31,180.81c-.24-3.41-9.57-5.22-12.71-6.4-3.14-1.18-15.7,1.96-15.7,1.96-12.17-3.14-54.55-9.03-78.88-9.03s-32.57,11.38-35.32,10.99c-2.75-.39-17.27-.78-23.55-1.96-6.28-1.18-5.1-14.13-39.25-26.48-34.14-12.35-68.29-12.42-68.29-12.42-13.35,4.66-6.76,18.49-6.76,18.49l2.05,6.35c4.32,2.03,3.14,10.52,4.71,23.08s7.46,28.65,14.13,38.46c6.67,9.81,31.79,20.8,44.35,21.19s23.55-1.96,31.79-15.31c8.24-13.34,16.88-36.89,16.88-36.89l10.2,1.57s2.91.31,5.35,3.09,4.43,8.03,7.6,17.31c7.56,22.1,25.12,39.25,25.12,39.25,0,0,5.6,7.43,33.44,12.66,23.08,4.34,42.7-2.46,42.7-2.46,17.72-7.17,21.63-44.96,21.63-44.96,0,0,1.83-13.3,7.81-16.65,7.37-4.14,8.27-4.44,12.71-5.32,3.61-.71.24-13.13,0-16.54ZM190.5,231.32c-9.42,5.1-32.18,7.06-46.31-3.92-14.13-10.99-20.8-30.22-22.76-52.98s7.1-25.23,7.1-25.23c0,0,14.88-.67,34.11,4.03,19.23,4.71,40.42,18.05,40.82,26.69.39,8.63-3.53,46.31-12.95,51.41ZM344.73,255.65c-9.03,4.32-21.47,4.71-31.93,3.92-10.46-.78-37.54-1.57-47.35-31.4,0,0-2.75-14.13-5.1-17.27-2.35-3.14-9.42-14.48-9.42-18.43,0-8.23,7.15-12.97,7.15-12.97,0,0,8.16-5.1,18.75-5.1,10.6,0,64.75,2.75,72.21,12.95,7.46,10.2,7.06,21.98,8.24,31.4,1.18,9.42-3.53,32.57-12.56,36.89Z"/>
                    </g>
                    <g id="verres-shape">
                      <path class="cls-5" d="M116.32,162.87c-.88,6.05.4,37.41,11.44,55.31s37.04,21.35,41.37,21.31,18.51,1.02,24.47-9.27c4.97-8.59,13.17-43.48,9.12-53.05-6.26-14.82-40.4-24.02-40.4-24.02,0,0-26.85-5.46-33.82-4.46,0,0-9.97-.96-12.17,14.17Z"/>
                      <path class="cls-5" d="M247.32,192.54s-1.09-9.55,19.57-16.69c11.76-4.06,60.46,3.23,60.46,3.23,0,0,19.09,4.06,21.71,8.28,2.62,4.22,9.46,17.24,8.29,37.97-1.14,20.21-7.31,26.8-12.61,30.31,0,0-7.1,4.93-21.34,5.93-26.65,1.88-37.01-1.14-46.19-7.73-29.88-21.46-29.88-61.3-29.88-61.3Z"/>
                    </g>
                  </g>
                </svg>
              </div>

              <div class="mt-4 flex gap-3">
                <button class="btn btn-ghost border" id="btn-save">Enregistrer</button>
                <button class="btn btn-neutral flex-1 justify-between">
                  <span>Commander</span>
                  <span class="opacity-80">189€</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Panneaux -->
        <div class="lg:col-span-7 grid gap-6">
          <div class="card bg-base-100 shadow-sm">
            <div class="card-body">
              <label class="label-text font-medium mb-2" for="nom-lunette">Nom de la lunette</label>
              <input id="nom-lunette" class="input input-bordered w-full" placeholder="Ma paire préférée" />
            </div>
          </div>

          <div class="grid md:grid-cols-2 gap-6">
            <!-- Matériaux -->
            <div class="card bg-base-100 shadow-sm">
              <div class="card-body">
                <h3 class="card-title text-base">Matériau de la monture</h3>
                <div class="mt-3 grid grid-cols-3 gap-3 min-w-0" id="mat-monture">
                  {MATS.map((m, i) => (
                    <button class={`btn btn-outline ${i===0?"btn-active":""} h-16 w-full min-w-0 overflow-hidden text-left flex flex-col items-start`}
                      data-kind="monture" data-mat={m.label}>
                      <span class="font-medium">{m.label}</span>
                      <span class="text-xs opacity-70 -mt-1">{m.sub}</span>
                    </button>
                  ))}
                </div>
              </div>
            </div>

            <div class="card bg-base-100 shadow-sm">
              <div class="card-body">
                <h3 class="card-title text-base">Matériau des branches</h3>
                <div class="mt-3 grid grid-cols-3 gap-3 min-w-0" id="mat-branches">
                  {MATS.map((m, i) => (
                    <button class={`btn btn-outline ${i===0?"btn-active":""} h-16 w-full min-w-0 overflow-hidden text-left flex flex-col items-start`}
                      data-kind="branches" data-mat={m.label}>
                      <span class="font-medium">{m.label}</span>
                      <span class="text-xs opacity-70 -mt-1">{m.sub}</span>
                    </button>
                  ))}
                </div>
              </div>
            </div>

            <!-- Sliders -->
            <div class="card bg-base-100 shadow-sm">
              <div class="card-body">
                <div class="flex items-center justify-between">
                  <h3 class="card-title text-base">Largeur du pont</h3>
                  <span id="pont-value" class="text-sm">18 mm</span>
                </div>
                <input id="pont" type="range" min="14" max="22" value="18" class="range range-sm mt-4" />
                <div class="flex justify-between text-xs opacity-60 mt-1">
                  <span>14 mm</span><span>22 mm</span>
                </div>
              </div>
            </div>

            <div class="card bg-base-100 shadow-sm">
              <div class="card-body">
                <div class="flex items-center justify-between">
                  <h3 class="card-title text-base">Taille des verres</h3>
                  <span id="verres-value" class="text-sm">50 mm</span>
                </div>
                <input id="verresRange" type="range" min="45" max="55" value="50" class="range range-sm mt-4" />
                <div class="flex justify-between text-xs opacity-60 mt-1">
                  <span>45 mm (Petit)</span><span>55 mm (Large)</span>
                </div>
              </div>
            </div>

            <!-- Couleurs -->
            <div class="card bg-base-100 shadow-sm">
              <div class="card-body">
                <h3 class="card-title text-base">Couleur de la monture</h3>
                <div class="mt-3 flex flex-wrap gap-3" id="color-monture">
                  {MONTURE_COLORS.map((c, i) => (
                    <button class={`btn btn-outline ${i===0?"btn-active":""} px-3`} data-kind="monture" data-color={c.value}>
                      <span class="inline-block w-6 h-6 rounded-full border" style={`background:${c.value}`}></span>
                      <span class="ml-2">{c.name}</span>
                    </button>
                  ))}
                </div>
              </div>
            </div>

            <div class="card bg-base-100 shadow-sm">
              <div class="card-body">
                <h3 class="card-title text-base">Couleur des branches</h3>
                <div class="mt-3 flex flex-wrap gap-3" id="color-branches">
                  {BRANCHES_COLORS.map((c, i) => (
                    <button class={`btn btn-outline ${i===1?"btn-active":""} px-3`} data-kind="branches" data-color={c.value}>
                      <span class="inline-block w-6 h-6 rounded-full border" style={`background:${c.value}`}></span>
                      <span class="ml-2">{c.name}</span>
                    </button>
                  ))}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <Footer />

<!-- JS -->
<script is:inline>
  const svg = document.getElementById('lunettes-svg');
  svg.style.setProperty('--monture-color', '#111827');  // Noir
  svg.style.setProperty('--branches-color', '#8b5a2b'); // Écaille

  const nomInput = document.getElementById('nom-lunette');

  function activateOne(container, btn) {
    container.querySelectorAll('button').forEach(b => b.classList.remove('btn-active'));
    btn.classList.add('btn-active');
  }

  // Couleurs
  document.querySelectorAll('#color-monture button').forEach(btn => {
    btn.addEventListener('click', () => {
      svg.style.setProperty('--monture-color', btn.dataset.color);
      activateOne(document.getElementById('color-monture'), btn);
    });
  });

  document.querySelectorAll('#color-branches button').forEach(btn => {
    btn.addEventListener('click', () => {
      svg.style.setProperty('--branches-color', btn.dataset.color);
      activateOne(document.getElementById('color-branches'), btn);
    });
  });

  // Matériaux
  document.querySelectorAll('#mat-monture button').forEach(btn => {
    btn.addEventListener('click', () => activateOne(document.getElementById('mat-monture'), btn));
  });

  document.querySelectorAll('#mat-branches button').forEach(btn => {
    btn.addEventListener('click', () => activateOne(document.getElementById('mat-branches'), btn));
  });

  // Sliders
  const pont = document.getElementById('pont');
  const verresRange = document.getElementById('verresRange');
  const pv = document.getElementById('pont-value');
  const vv = document.getElementById('verres-value');

  const fmt = (v) => Number.parseInt(String(v), 10) + ' mm';
  const update = () => {
    pv.textContent = fmt(pont.value);
    vv.textContent = fmt(verresRange.value);
  };
  pont.addEventListener('input', update);
  verresRange.addEventListener('input', update);
  update();

  // === Enregistrement PB via /api/save-svg ===
  const saveBtn = document.getElementById('btn-save');

  saveBtn.addEventListener('click', async () => {
    const btn = saveBtn;
    btn.disabled = true;
    btn.textContent = "Enregistrement...";

    const mm = document.querySelector('#mat-monture .btn-active span.font-medium')?.textContent.trim() || null;
    const mb = document.querySelector('#mat-branches .btn-active span.font-medium')?.textContent.trim() || null;
    const cm = document.querySelector('#color-monture .btn-active span.ml-2')?.textContent.trim() || null;
    const cb = document.querySelector('#color-branches .btn-active span.ml-2')?.textContent.trim() || null;

    const payload = {
      nom_lunette: nomInput.value?.trim() || null,
      cod_svg: document.getElementById('lunettes-svg').outerHTML,
      largeur_pont_mm: Number.parseInt(pont.value, 10),
      taille_verre_mm: Number.parseInt(verresRange.value, 10),

      // libellés pour résolution d'IDs côté serveur
      matMontLabel: mm,
      matBraLabel: mb,
      colMontLabel: cm,
      colBraLabel: cb,
    };

    try {
      const res = await fetch("/apia/save-svg", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify(payload)
      });

      const out = await res.json().catch(() => ({}));

      if (!res.ok || out.success === false) {
        alert("Échec de l’enregistrement.\n" + (out.error || "Server error"));
        btn.disabled = false;
        btn.textContent = "Enregistrer";
        return;
      }

      alert("Modèle enregistré ✅");
      btn.textContent = "Enregistré ✓";
      btn.disabled = false;

    } catch (err) {
      console.error(err);
      alert("Échec de l’enregistrement (réseau).");
      btn.disabled = false;
      btn.textContent = "Enregistrer";
    }
  });
</script>

  </body>
</html>
