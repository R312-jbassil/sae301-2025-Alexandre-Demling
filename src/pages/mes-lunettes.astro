---
import BaseLayout from "../layouts/BaseLayout.astro";
import pb from "../utils/pb.ts";

export const prerender = false;

// Auth
const user = Astro.locals.user;
if (!user) {
  throw Astro.redirect("/?redirect=/mes-lunettes");
}

// Récupération des lunettes
let lunettes = [];
try {
  lunettes = await pb.collection("Lunette").getFullList({
    filter: `id_user ~ "${user.id}" || id_utilisateur ~ "${user.id}"`,
    sort: "-created",
    expand: "materiaux_monture,materiaux_branche,couleur_monture,couleur_branche",
  });
} catch (err) {
  console.error("Erreur PB (Mes lunettes):", err);
}
---

<BaseLayout title="TaVue — Mes lunettes" active="creations">
  <section class="max-w-7xl mx-auto px-6 py-12">
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-extrabold">Mes lunettes</h1>
      <a href="/configurateur" class="btn btn-neutral">Nouvelle création</a>
    </div>

    {lunettes.length === 0 ? (
      <p class="opacity-70">Aucune création pour l’instant.</p>
    ) : (
      <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
        {lunettes.map((it) => (
          <div class="card bg-base-100 shadow-sm overflow-hidden" data-card-id={it.id}>
            <div class="p-4 bg-base-200" set:html={it.code_svg}></div>

            <div class="card-body gap-3">
              <div class="font-semibold">
                Pont {it.largeur_pont_mm ?? "—"} mm · Verres {it.taille_verre_mm ?? "—"} mm
              </div>

              <div class="text-sm opacity-70">
                Monture :
                {it.expand?.materiaux_monture?.libelle ?? "—"}
                (
                {it.expand?.couleur_monture?.nom_couleur ?? "—"}
                )
                · Branches :
                {it.expand?.materiaux_branche?.libelle ?? "—"}
                (
                {it.expand?.couleur_branche?.nom_couleur ?? "—"}
                )
              </div>

              <div class="card-actions justify-between mt-2">
                <a class="btn btn-sm" href={`/configurateur/ia?id=${it.id}`}>Modifier avec l’IA</a>
                <button class="btn btn-ghost btn-sm border btn-delete" data-id={it.id}>Supprimer</button>
              </div>
            </div>
          </div>
        ))}
      </div>
    )}
  </section>

  <script is:inline>
    // suppression côté client
    document.querySelectorAll(".btn-delete").forEach((btn) => {
      btn.addEventListener("click", async () => {
        const id = btn.dataset.id;
        if (!id) return;

        if (!confirm("Supprimer cette création ?")) return;

        btn.disabled = true;
        btn.textContent = "Suppression...";

        try {
          const res = await fetch("/api/lunettes/delete", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ id }),
          });

          const data = await res.json().catch(() => ({}));

          if (!res.ok) {
            alert(data.error || "Échec de la suppression.");
            btn.disabled = false;
            btn.textContent = "Supprimer";
            return;
          }

          // Retire la carte du DOM
          const card = document.querySelector(`[data-card-id="${id}"]`);
          card?.remove();
        } catch (e) {
          console.error(e);
          alert("Échec de la suppression.");
          btn.disabled = false;
          btn.textContent = "Supprimer";
        }
      });
    });
  </script>
</BaseLayout>
